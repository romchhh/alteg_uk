# Інтеграція Bitrix24 CRM (ALTEG UK)

## Як це працює

Сайт (Next.js) при відправці форм **не викликає PHP-скрипт**. Замість цього серверні API-маршрути (Node.js) напряму викликають REST API Bitrix24 через вебхук. Логіка та сама, що в твоєму PHP-скрипті: створення лідів, прив’язка до існуючого контакту/компанії за телефоном або email.

### Потік даних

1. **Користувач** заповнює форму на сайті (контакт, замовлення, wholesale).
2. **Фронт** відправляє `POST` на наш API (наприклад `/api/contact`, `/api/order`, `/api/wholesale-inquiry`).
3. **Сервер** валідує дані, зберігає замовлення в БД (якщо це замовлення), потім викликає **Bitrix24** через `lib/services/bitrix24.ts`.
4. У **Bitrix24** створюється лід (або оновлюється існуючий залежно від логіки). Додатково може відправлятися сповіщення в Telegram.

---

## Які форми куди йдуть

| Форма на сайті          | API-маршрут              | Що відправляється в CRM |
|-------------------------|--------------------------|---------------------------|
| **Контакт (зв’язок)**   | `POST /api/contact`      | Лід: ім’я, телефон, коментар (інтерес). Джерело: WEB. |
| **Замовлення**          | `POST /api/order`        | Лід: клієнт, адреса, коментар з деталями замовлення, сума, вага, список товарів. Джерело: WEB. |
| **Wholesale (запит)**   | `POST /api/wholesale-inquiry` | Лід: компанія, контакт, email, телефон, повідомлення. Джерело: WEB. |

У всіх випадках перед створенням ліда виконується **пошук по телефону та email** у контактах і компаніях Bitrix24. Якщо знайдено контакт — лід прив’язується до нього (`CONTACT_ID`). Якщо знайдено компанію — прив’язується до неї (`COMPANY_ID`). Відповідальний (`ASSIGNED_BY_ID`) береться з знайденого контакту/компанії або з налаштування `NEXT_PUBLIC_BITRIX24_USER_ID`.

---

## Налаштування

### 1. Вебхук Bitrix24

#### Покрокова інструкція створення вебхука:

**Крок 1:** Зайди в свій портал Bitrix24  
- Відкрий `https://твоя-компанія.bitrix24.ua` або `https://твоя-компанія.bitrix24.com` у браузері
- Увійди під своїм обліковим записом

**Крок 2:** Перейди до налаштувань вебхуків  
- У лівому меню знайди **"Розробникам"** (або **"Developers"** / **"Настройки"** → **"Разработчикам"**)
- Оберіть **"Другое"** → **"Входящий вебхук"** (або **"Incoming webhook"** / **"Інші інтеграції"** → **"Вебхуки"**)

**Крок 3:** Створи новий вебхук  
- Натисни кнопку **"Добавить"** (або **"Add"** / **"Створити"**)
- Заповни форму:
  - **Назва вебхука:** наприклад "ALTEG UK Website Integration" або "Website Forms"
  - **Права доступу:** оберіть **CRM** (потрібні права на ліди, контакти, компанії)
    - Відміть: `crm` (CRM), `crm.lead`, `crm.contact`, `crm.company`
    - Можна також додати `crm.product` якщо плануєш синхронізувати товари
  - **Користувач:** оберіть користувача, від імені якого будуть виконуватися запити (наприклад, адміністратор або менеджер)
  - **Термін дії:** можна залишити "Без обмежень" (або встановити дату за потреби)

**Крок 4:** Збережи та скопіюй URL  
- Натисни **"Сохранить"** (або **"Save"**)
- Після створення Bitrix24 покаже **URL вебхука** — скопіюй його повністю
- URL має виглядати так:
  ```
  https://твоя-компанія.bitrix24.ua/rest/1/xxxxxxxxxxxxxxxx
  ```
  або
  ```
  https://твоя-компанія.bitrix24.com/rest/1/xxxxxxxxxxxxxxxx
  ```
  де:
  - `1` (або інше число) — ID користувача, від імені якого працює вебхук
  - `xxxxxxxxxxxxxxxx` — унікальний код вебхука (довгий рядок символів)

**Крок 5:** Онови `.env`  
- Відкрий `.env` у корені проєкту
- Встав скопійований URL у `NEXT_PUBLIC_BITRIX24_WEBHOOK_URL`:
  ```env
  NEXT_PUBLIC_BITRIX24_WEBHOOK_URL=https://твоя-компанія.bitrix24.ua/rest/1/xxxxxxxxxxxxxxxx
  NEXT_PUBLIC_BITRIX24_USER_ID=1
  ```
  (заміни `1` на ID користувача з URL, якщо воно інше)

**Крок 6:** Перезапусти сервер  
- Зупини dev-сервер (Ctrl+C)
- Запусти знову: `npm run dev` або `yarn dev`

**Важливо:**
- **Без слеша в кінці:** URL має бути без `/` в кінці (наприклад `.../rest/1/код`, а не `.../rest/1/код/`)
- **Без методу:** Не додавай `/crm.lead.add` або `.json` — сервіс сам додасть метод і `.json` при виклику
- **Якщо користувача видалять:** Якщо користувача, від імені якого створено вебхук, видалять з Bitrix24, вебхук перестане працювати — потрібно буде створити новий
- **Безпека:** Не публікуй вебхук у публічних репозиторіях — це дає доступ до твоєї CRM

### 2. Змінні оточення

У корені проєкту створіть або доповніть `.env.local`:

```env
# Bitrix24 (обов'язково для відправки лідів у CRM)
NEXT_PUBLIC_BITRIX24_WEBHOOK_URL=https://b24-vizoiz.bitrix24.ua/rest/5/3e6f3hza1ir7b742

# ID користувача Bitrix24, якому призначатимуться нові ліди, якщо контакт/компанія не знайдені (опційно)
NEXT_PUBLIC_BITRIX24_USER_ID=5
```

- Якщо **вебхук прив’язаний до користувача** (наприклад, 5), після видалення цього користувача вебхук перестане працювати — потрібно буде згенерувати новий і оновити `NEXT_PUBLIC_BITRIX24_WEBHOOK_URL`.
- `NEXT_PUBLIC_BITRIX24_USER_ID` — це саме той «ід відповідального», який у твоєму PHP був `ASSIGNED_BY_ID=>5` для нових лідів без існуючого контакту/компанії.

### 3. Перезапуск

Після зміни `.env.local` перезапусти dev-сервер (`npm run dev` або `yarn dev`).

---

## Що реалізовано в коді (відповідно до твого скрипта)

- **Загальний виклик CRM** — `requestToCRM(method, data)` у `lib/services/bitrix24.ts`. Аналог твого `AuspexLG::requestToCRM($data, $method)` з використанням `.json` і тілом у форматі `{ "fields": { ... } }`.
- **Пошук контакту за телефоном** — `crm.contact.list` з фільтром `PHONE` (нормалізований номер).
- **Пошук контакту за email** — `crm.contact.list` з фільтром `EMAIL`.
- **Пошук компанії за телефоном / email** — `crm.company.list` з відповідними фільтрами.
- **Створення ліда** — `crm.lead.add` з полями TITLE, NAME, PHONE, EMAIL, COMMENTS, SOURCE_ID, CONTACT_ID або COMPANY_ID (якщо знайдені), ASSIGNED_BY_ID.
- **Форми:**
  - **Контакт** — лід з назвою типу «ALTEG UK Contact Form - …», коментар з інтересом.
  - **Замовлення** — лід «ALTEG UK Order - …» з повним описом замовлення, сумою, вагою, списком товарів.
  - **Wholesale** — лід «ALTEG UK Wholesale Inquiry - …» з компанією, контактом і повідомленням.

У твоєму PHP були окремі блоки для «реєстрація», «написати керівнику», «ремонт», «оренда», «тест-драйв», «питання по товару», «замовлення». На сайті ALTEG є лише три типи подій (контакт, замовлення, wholesale), тому зараз у CRM завжди створюються **ліди** з джерелом WEB. Якщо потрібні різні типи угод або напрямки (категорії) — їх можна додати пізніше через окремі методи або поля (наприклад, `SOURCE_DESCRIPTION` або UF-поля).

---

## Файли

- **Сервіс Bitrix24:** `lib/services/bitrix24.ts` — вебхук, пошук контактів/компаній, створення лідів для замовлень і quote.
- **API форм:**
  - `app/api/contact/route.ts` — форма зв’язку.
  - `app/api/order/route.ts` — оформлення замовлення (внутрішньо викликає `createOrderLead` після збереження замовлення).
  - `app/api/wholesale-inquiry/route.ts` — запит wholesale.
- **Змінні:** `config/env.ts` — читання `NEXT_PUBLIC_BITRIX24_WEBHOOK_URL` та `NEXT_PUBLIC_BITRIX24_USER_ID`.

Якщо потрібно винести вебхук у окремий PHP-скрипт на твоєму сервері — можна зробити так: форми як раніше відправляють дані на наш API, а API робить один `POST` на твій PHP, який уже викликає Bitrix24. Зараз реалізовано варіант «сайт → наш API → напряму Bitrix24», без PHP.
